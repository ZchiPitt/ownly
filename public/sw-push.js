/**
 * Custom service worker for push notifications
 * This file is imported by the main service worker generated by vite-plugin-pwa
 */

/**
 * Handle incoming push notifications
 */
self.addEventListener('push', (event) => {
  console.log('[Service Worker] Push received:', event);

  let notificationData = {
    title: 'Ownly',
    body: 'You have a new notification',
    data: {},
    type: 'system',
  };

  if (event.data) {
    try {
      const payload = event.data.json();
      console.log('[Service Worker] Push payload:', payload);

      notificationData = {
        title: payload.title || notificationData.title,
        body: payload.body || notificationData.body,
        data: payload.data || {},
        type: payload.type || 'system',
        notification_id: payload.notification_id,
      };
    } catch (error) {
      console.error('[Service Worker] Error parsing push data:', error);
      // Try text format as fallback
      notificationData.body = event.data.text();
    }
  }

  const options = {
    body: notificationData.body,
    icon: '/icons/icon-192x192.png',
    badge: '/icons/icon-72x72.png',
    tag: notificationData.notification_id || `notification-${Date.now()}`,
    renotify: true,
    requireInteraction: false,
    data: {
      ...notificationData.data,
      type: notificationData.type,
      notification_id: notificationData.notification_id,
    },
  };

  event.waitUntil(
    self.registration.showNotification(notificationData.title, options)
  );
});

/**
 * Handle notification click events
 * Routes user to appropriate page based on notification type
 */
self.addEventListener('notificationclick', (event) => {
  console.log('[Service Worker] Notification clicked:', event);

  event.notification.close();

  const notificationData = event.notification.data || {};
  const notificationType = notificationData.type;
  const listingId = notificationData.listing_id;

  // Determine the URL to open based on notification type
  let targetUrl = '/notifications';

  // Transaction notification types that should open listing detail
  const transactionTypes = [
    'new_inquiry',
    'purchase_request',
    'request_accepted',
    'request_declined',
    'transaction_complete',
  ];

  if (notificationType === 'new_message' && listingId) {
    // Chat messages open the messages/chat page
    targetUrl = `/messages/${listingId}`;
  } else if (transactionTypes.includes(notificationType) && listingId) {
    // Transaction notifications open the listing detail page
    targetUrl = `/listing/${listingId}`;
  } else if (listingId) {
    // Other marketplace notifications with listing_id open the listing
    targetUrl = `/listing/${listingId}`;
  }

  console.log('[Service Worker] Opening URL:', targetUrl);

  event.waitUntil(
    clients.matchAll({ type: 'window', includeUncontrolled: true }).then((clientList) => {
      // Check if there's already an open window we can focus
      for (const client of clientList) {
        const clientUrl = new URL(client.url);
        // If we have a window open at the app origin, navigate and focus it
        if (clientUrl.origin === self.location.origin) {
          client.navigate(targetUrl);
          return client.focus();
        }
      }
      // No existing window, open a new one
      return clients.openWindow(targetUrl);
    })
  );
});

/**
 * Handle notification close events (optional - for analytics)
 */
self.addEventListener('notificationclose', (event) => {
  console.log('[Service Worker] Notification closed:', event);
});

console.log('[Service Worker] Push notification handlers registered');
