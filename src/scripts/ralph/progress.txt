# Ralph Progress Log
## Codebase Patterns
- Pattern: Expo lint errors when standard folders exist without lintable files; add minimal `index.ts` placeholders during scaffolding.
- Pattern: For iOS-only Expo stories, Playwright MCP can only verify browser-side prerequisites (server reachability/artifact capture); simulator verification still needs manual execution.
- Pattern: `ActionSheetIOS` is a low-dependency native control for inventory sort/location/category pickers and maps cleanly to TanStack Query keys.
- Pattern: Supabase typed `.maybeSingle()` queries can infer `never` for selected rows in mobile hooks; cast once to a concrete shared type (`Item | null`) before field access.
- Pattern: Reuse a single `ItemEditorForm` for create and edit routes, and keep Supabase mutation wiring in the next story to avoid mixing form UX and persistence concerns.
- Pattern: In this codebase, Supabase typed writes to `items` may infer `never`; keep mutation payload shaping explicit and use narrow casts at the write callsite until shared DB typings are normalized.
- Pattern: `expo-image-picker` with `allowsEditing` and route params (`imageUri`, `source`) gives a lightweight camera/library flow for iOS before upload/analyze logic is added.
- Pattern: For mobile image preprocessing, use `expo-image-manipulator` in a two-pass JPEG pipeline (main + fallback compression) and compute output size via `fetch(uri).blob().size` to enforce a max-byte guard before upload.
- Pattern: `analyze-image` expects `storage_path` with the bucket prefix (for example `items/<user-id>/<filename>.jpg`), even when the Storage upload API returns a bucket-relative path.
- Pattern: For Expo Router quick-add flows, pass single-detection payload via route params (JSON-stringify arrays/tuples) and parse defensively on the confirmation screen before mutation submission.
- Pattern: For multi-detection add flows, serialize the full `detected_items` array into route params, then support both direct batch-save and `ItemEditorForm`-driven sequential edits from the same parsed payload.
- Pattern: For analyze fallback flows, keep uploaded storage paths in screen state and only clean them on explicit cancel; clear cleanup state before navigating into manual/quick/batch save paths.
- Pattern: For mobile inventory search, combine text-field item queries with category/location ID prefilter queries, then dedupe/sort by `updated_at` to avoid brittle joined `.or()` conditions in Supabase.
Started: Tue Feb 10 02:57:51 PST 2026
---
## 2026-02-10 03:03 - US-001
- What was implemented: Scaffolded the `mobile/` Expo Router iOS app with baseline screens/config, added placeholder index files for core folders, and documented mobile setup commands in `README.md`.
- Files changed: `.gitignore`, `mobile/package.json`, `mobile/app.json`, `mobile/babel.config.js`, `mobile/tsconfig.json`, `mobile/expo-env.d.ts`, `mobile/.eslintrc.cjs`, `mobile/app/_layout.tsx`, `mobile/app/index.tsx`, `mobile/components/index.ts`, `mobile/contexts/index.ts`, `mobile/hooks/index.ts`, `mobile/lib/index.ts`, `mobile/types/index.ts`, `README.md`, `src/scripts/ralph/prd.json`
- **Learnings for future iterations:**
  - Patterns discovered: Expo lint expects lintable files in standard app folders; placeholder `index.ts` files prevent empty-directory lint failures.
  - Gotchas encountered: `expo lint` fails when target directories only contain `.gitkeep`.
  - Useful context: Initial iOS scaffold uses Expo Router with `expo-router` Babel plugin and `main` set to `expo-router/entry`.
---
## 2026-02-10 03:09 - US-002
- What was implemented: Added a typed Supabase client for mobile that reads Expo public env vars with a clear startup error when missing, plus TypeScript env typings.
- Files changed: `mobile/lib/supabase.ts`, `mobile/lib/index.ts`, `mobile/expo-env.d.ts`, `mobile/tsconfig.json`, `mobile/package.json`, `mobile/package-lock.json`, `src/scripts/ralph/prd.json`
- **Learnings for future iterations:**
  - Patterns discovered: None.
  - Gotchas encountered: None.
  - Useful context: Expo public env vars should be read via `process.env.EXPO_PUBLIC_*`.
---
## 2026-02-10 03:12 - US-003
- What was implemented: Added AuthProvider with Supabase auth state handling and secure storage-backed session persistence, plus auth gating/redirects and placeholder auth/home screens.
- Files changed: `mobile/app/_layout.tsx`, `mobile/app/(auth)/login.tsx`, `mobile/app/(tabs)/index.tsx`, `mobile/contexts/AuthProvider.tsx`, `mobile/contexts/index.ts`, `mobile/lib/supabase.ts`, `mobile/package.json`, `mobile/package-lock.json`, `src/scripts/ralph/prd.json`
- **Learnings for future iterations:**
  - Patterns discovered: None.
  - Gotchas encountered: None.
  - Useful context: Auth gate redirects to `(auth)` when session is missing and to `(tabs)` when session exists.
---
## 2026-02-10 05:34 - US-004
- What was implemented: Built login, signup, and reset password screens with validation, loading states, Supabase auth calls, and auth navigation links.
- Files changed: `mobile/app/(auth)/login.tsx`, `mobile/app/(auth)/signup.tsx`, `mobile/app/(auth)/reset.tsx`, `src/scripts/ralph/prd.json`
- **Learnings for future iterations:**
  - Patterns discovered: None.
  - Gotchas encountered: iOS simulator verification not run in this environment; manual verification still required for auth flows.
  - Useful context: Auth gate redirects after session updates; screens only need to call Supabase auth methods.
---
## 2026-02-10 05:39 - US-005
- What was implemented: Added Expo Router tab shell with iOS-style stacks and placeholder detail routes for Inventory, Add, Search, Marketplace, and Settings. Added SafeAreaProvider and shared Screen wrapper for safe-area handling.
- Files changed: `mobile/app/_layout.tsx`, `mobile/app/(tabs)/_layout.tsx`, `mobile/app/(tabs)/index.tsx`, `mobile/app/(tabs)/inventory/_layout.tsx`, `mobile/app/(tabs)/inventory/index.tsx`, `mobile/app/(tabs)/inventory/[id].tsx`, `mobile/app/(tabs)/add/_layout.tsx`, `mobile/app/(tabs)/add/index.tsx`, `mobile/app/(tabs)/add/preview.tsx`, `mobile/app/(tabs)/search/_layout.tsx`, `mobile/app/(tabs)/search/index.tsx`, `mobile/app/(tabs)/search/results.tsx`, `mobile/app/(tabs)/marketplace/_layout.tsx`, `mobile/app/(tabs)/marketplace/index.tsx`, `mobile/app/(tabs)/marketplace/[id].tsx`, `mobile/app/(tabs)/settings/_layout.tsx`, `mobile/app/(tabs)/settings/index.tsx`, `mobile/app/(tabs)/settings/[section].tsx`, `mobile/components/Screen.tsx`, `mobile/components/index.ts`, `src/scripts/ralph/prd.json`
- **Learnings for future iterations:**
  - Patterns discovered: None.
  - Gotchas encountered: Playwright MCP/browser verification is not applicable for iOS-only Expo UI; manual simulator verification still required.
  - Useful context: Stack headers are configured per tab to keep iOS large titles while Tabs handles the bottom bar.
---
## 2026-02-10 05:50 - US-006
- What was implemented: Added inventory infinite pagination using TanStack Query and Supabase with current-user + non-deleted filters, then wired the Inventory tab to real data with loading, empty, error, retry, and list-end load-more states.
- Files changed: `mobile/app/_layout.tsx`, `mobile/app/(tabs)/inventory/index.tsx`, `mobile/hooks/useInventoryItems.ts`, `mobile/hooks/index.ts`, `mobile/lib/queryClient.ts`, `mobile/lib/index.ts`, `mobile/package.json`, `mobile/package-lock.json`, `src/scripts/ralph/prd.json`
- **Learnings for future iterations:**
  - Patterns discovered: Root-level `QueryClientProvider` keeps story-level data hooks minimal and reusable across tabs.
  - Gotchas encountered: Playwright MCP was reachable, but browser verification could not target this iOS-only flow; `playwright.browser_navigate` to `http://127.0.0.1:5173` returned `ERR_CONNECTION_REFUSED`.
  - Useful context: Captured Playwright MCP snapshot output for the failed browser navigation; manual iOS simulator verification is still required for Inventory pagination behavior.
---
## 2026-02-10 05:54 - US-007
- What was implemented: Added inventory sort controls (newest, oldest, name A-Z, name Z-A, expiring, viewed) plus category/location filter controls with iOS-native action sheets, and wired all state into the inventory query so sort/filter changes re-fetch with matching Supabase query clauses.
- Files changed: `mobile/app/(tabs)/inventory/index.tsx`, `mobile/hooks/useInventoryItems.ts`, `src/scripts/ralph/prd.json`
- **Learnings for future iterations:**
  - Patterns discovered: `ActionSheetIOS` works well for single-select filters without adding picker dependencies.
  - Gotchas encountered: Playwright MCP browser verification still cannot reach local dev server in this environment (`http://127.0.0.1:5173` and `http://localhost:5173` both returned `ERR_CONNECTION_REFUSED`) even while Vite reported ready.
  - Useful context: Verification artifacts captured with Playwright MCP snapshot and screenshot (`../../../var/folders/hs/2948r5010wn2c6_35jjmsm6w0000gn/T/playwright-mcp-output/1770731406242/page-2026-02-10T13-53-56-135Z.png`); manual iOS simulator verification remains required for this story.
---
## 2026-02-10 05:57 PST - US-008
- What was implemented: Replaced placeholder inventory detail with a fully data-driven detail experience using Supabase + TanStack Query, including photo display, core item fields, category/location resolution, tags, and metadata sections with null-safe fallback values.
- Files changed: `mobile/app/(tabs)/inventory/[id].tsx`, `mobile/hooks/useInventoryItemDetail.ts`, `mobile/hooks/index.ts`, `src/scripts/ralph/prd.json`
- **Learnings for future iterations:**
  - Patterns discovered: Supabase `.maybeSingle()` item fetches may need an explicit cast to shared `Item` type before field access to avoid `never` inference.
  - Gotchas encountered: Playwright MCP server was healthy but could not connect to local Vite server from MCP browser (`ERR_CONNECTION_REFUSED` for both `http://127.0.0.1:5173` and `http://localhost:5173`), so simulator verification remains manual.
  - Useful context: Captured MCP verification artifacts at `us-008-verification.png` and `us-008-localhost.png`, plus browser snapshots of the connection error state.
---
## 2026-02-10 06:01 PST - US-009
- What was implemented: Added a reusable iOS-native `ItemEditorForm` with validation for required/typed fields, then wired create mode (`/(tabs)/add/manual`) and edit mode (`/(tabs)/inventory/edit/[id]`) screens and navigation entry points from Add and Item Detail.
- Files changed: `mobile/components/ItemEditorForm.tsx`, `mobile/components/index.ts`, `mobile/app/(tabs)/add/manual.tsx`, `mobile/app/(tabs)/add/index.tsx`, `mobile/app/(tabs)/inventory/edit/[id].tsx`, `mobile/app/(tabs)/inventory/[id].tsx`, `src/scripts/ralph/prd.json`
- **Learnings for future iterations:**
  - Patterns discovered: Shared form component keeps create/edit fields and validation logic in one place while allowing story-by-story backend wiring.
  - Gotchas encountered: Playwright MCP verification could run and capture artifacts, but browser navigation to local server still failed with `ERR_CONNECTION_REFUSED`, so simulator verification remains manual.
  - Useful context: Verification artifacts captured at `us-009-verification.png` with MCP snapshot showing `chrome-error://chromewebdata/` unreachable state.
---
## 2026-02-10 06:05 PST - US-010
- What was implemented: Added inventory mutation hooks for create/update/toggle favorite/soft delete with shared value mapping and TanStack Query cache invalidation, then wired manual add and edit submit flows to persist changes and updated item detail with favorite/delete actions.
- Files changed: `mobile/hooks/useInventoryItemMutations.ts`, `mobile/hooks/index.ts`, `mobile/app/(tabs)/add/manual.tsx`, `mobile/app/(tabs)/inventory/edit/[id].tsx`, `mobile/app/(tabs)/inventory/[id].tsx`, `src/scripts/ralph/prd.json`
- **Learnings for future iterations:**
  - Patterns discovered: Centralizing item mutation payload mapping avoids create/edit drift and keeps form value normalization in one place.
  - Gotchas encountered: Playwright MCP server was healthy, but navigation to local dev URL still returned `ERR_CONNECTION_REFUSED`, so browser verification was limited to connection-error artifact capture and iOS simulator verification remains manual.
  - Useful context: Required MCP checks executed (`mcporter list`, `playwright.browser_navigate`, `playwright.browser_snapshot`, `playwright.browser_take_screenshot`) with artifact `us-010-verification.png`.
---
## 2026-02-10 06:08 PST - US-011
- What was implemented: Added Add-screen actions for camera capture and photo library selection using `expo-image-picker`, including denied-permission alerts with retry guidance, and wired selected images into the preview route with an actual image preview state before upload.
- Files changed: `mobile/app/(tabs)/add/index.tsx`, `mobile/app/(tabs)/add/preview.tsx`, `mobile/app.json`, `mobile/package.json`, `mobile/package-lock.json`, `src/scripts/ralph/prd.json`
- **Learnings for future iterations:**
  - Patterns discovered: `expo-image-picker` with route param handoff (`imageUri`, `source`) keeps photo selection and preview loosely coupled and easy to extend into upload/analyze stories.
  - Gotchas encountered: Playwright MCP cannot validate iOS simulator UI directly; browser verification artifacts only confirm MCP flow execution and local web reachability.
  - Useful context: Browser verification commands executed: `mcporter list`, `mcporter call playwright.browser_navigate url=http://127.0.0.1:5173`, `mcporter call playwright.browser_snapshot`, `mcporter call playwright.browser_take_screenshot filename=us-011-verification.png`.
---
## 2026-02-10 06:11 PST - US-012
- What was implemented: Added a reusable mobile image preprocessing pipeline using `expo-image-manipulator` that converts input to JPEG, applies resize/compression with a max-size guard, handles HEIC/HEIF conversion failures with actionable messaging, and generates a thumbnail artifact; wired the Add preview flow to run processing and display resulting upload/thumbnail metadata.
- Files changed: `mobile/lib/imageProcessing.ts`, `mobile/lib/index.ts`, `mobile/app/(tabs)/add/index.tsx`, `mobile/app/(tabs)/add/preview.tsx`, `mobile/package.json`, `mobile/package-lock.json`, `src/scripts/ralph/prd.json`
- **Learnings for future iterations:**
  - Patterns discovered: Two-pass JPEG processing keeps quality acceptable while enforcing upload byte limits for AI/storage inputs.
  - Gotchas encountered: Playwright MCP screenshot output may not persist inside repo paths by default; rely on command output/logged artifact names unless an explicit writable path is provided.
  - Useful context: Browser verification succeeded against local web app during this iteration (`mcporter list`, `playwright.browser_navigate`, `playwright.browser_snapshot`, `playwright.browser_take_screenshot filename=us-012-verification.png`) while iOS simulator validation for this mobile flow remains manual.
---
## 2026-02-10 06:14 PST - US-013
- What was implemented: Added mobile AI analyze wiring from Add Preview by uploading processed + thumbnail JPEGs to Supabase Storage under the authenticated user path, invoking the `analyze-image` Edge Function with `storage_path`, and rendering detected results with explicit uploading/analyzing/timeout/error states.
- Files changed: `mobile/lib/analyzeImage.ts`, `mobile/lib/index.ts`, `mobile/app/(tabs)/add/preview.tsx`, `src/scripts/ralph/prd.json`
- **Learnings for future iterations:**
  - Patterns discovered: Include the bucket prefix (`items/`) in `storage_path` when invoking `analyze-image`, even though upload calls use bucket-relative paths.
  - Gotchas encountered: Playwright MCP workflow executed, but browser navigation to `http://127.0.0.1:5173` returned `ERR_CONNECTION_REFUSED` in this environment; iOS simulator verification is still manual.
  - Useful context: Verification commands run: `mcporter list`, `mcporter call playwright.browser_navigate url=http://127.0.0.1:5173`, `mcporter call playwright.browser_snapshot`, `mcporter call playwright.browser_take_screenshot filename=us-013-verification.png`.
---
## 2026-02-10 06:17 PST - US-014
- What was implemented: Added a single-item quick-add flow by wiring Add Preview to expose a dedicated Quick Add confirmation screen when exactly one detection is returned; the confirmation screen persists the item in one tap using `useCreateInventoryItemMutation` with image URLs, `ai_metadata`, and `source_batch_id`, then routes to Inventory.
- Files changed: `mobile/app/(tabs)/add/preview.tsx`, `mobile/app/(tabs)/add/quick-add.tsx`, `src/scripts/ralph/prd.json`, `src/scripts/ralph/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: For Expo Router quick-add flows, serialize array/tuple detection fields (tags/bbox) into route params and parse defensively on the destination screen.
  - Gotchas encountered: `mcporter call playwright.browser_navigate` requires `url=...` argument style in this environment; JSON-argument style returned a validation error.
  - Useful context: Required browser verification commands completed successfully against local web server (`mcporter list`, `playwright.browser_navigate`, `playwright.browser_snapshot`, `playwright.browser_take_screenshot`) with artifact `us-014-verification.png`; iOS simulator validation for this mobile-only flow remains manual.
---
## 2026-02-10 15:31 PST - US-015
- What was implemented: Added a dedicated multi-item add flow for AI results with more than one detection by wiring Add Preview to route to a new Batch Add screen, where users can select detections, save all selected items in one batch, or run a sequential edit-and-save flow using `ItemEditorForm` for each selected detection. Each created item persists shared image URLs and `source_batch_id` from the analyzed photo.
- Files changed: `mobile/app/(tabs)/add/preview.tsx`, `mobile/app/(tabs)/add/batch-add.tsx`, `src/scripts/ralph/prd.json`, `src/scripts/ralph/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Reusing `ItemEditorForm` in a keyed sequential queue allows per-detection edits without duplicating validation logic while keeping batch-save and edit flows in one screen.
  - Gotchas encountered: Playwright MCP could execute and capture artifacts, but local browser navigation to `http://127.0.0.1:5173` failed with `ERR_CONNECTION_REFUSED` in this environment.
  - Useful context: Required browser verification commands were run (`mcporter list`, `mcporter call playwright.browser_navigate url=http://127.0.0.1:5173`, `mcporter call playwright.browser_snapshot`, `mcporter call playwright.browser_take_screenshot filename=us-015-verification.png`); iOS simulator verification remains manual for this mobile-only flow.
---
## 2026-02-10 15:34 PST - US-016
- What was implemented: Added an explicit AI failure fallback path on Add Preview with retry/manual/cancel actions, tracked temporary upload paths for cleanup, and wired cancel-flow cleanup against Supabase Storage. Updated Manual Entry to open with the selected image prefilled (local URI or uploaded storage URL) and persist that image context when creating the item.
- Files changed: `mobile/lib/analyzeImage.ts`, `mobile/lib/index.ts`, `mobile/app/(tabs)/add/preview.tsx`, `mobile/app/(tabs)/add/manual.tsx`, `src/scripts/ralph/prd.json`, `src/scripts/ralph/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Persist upload-path cleanup candidates in UI state and clear them as soon as the user commits to a save path to avoid deleting images that should become canonical item photos.
  - Gotchas encountered: Playwright MCP verification commands ran, but browser navigation to `http://127.0.0.1:5173` returned `ERR_CONNECTION_REFUSED` in this environment.
  - Useful context: Verification commands/artifact: `mcporter list`, `mcporter call playwright.browser_navigate url=http://127.0.0.1:5173`, `mcporter call playwright.browser_snapshot`, `mcporter call playwright.browser_take_screenshot filename=us-016-verification.png`; iOS simulator fallback verification remains manual.
---
## 2026-02-10 15:37 PST - US-017
- What was implemented: Replaced the placeholder Search tab with a real inventory text-search flow using 300ms debounced input, TanStack Query, and Supabase. Added a new `useInventorySearch` hook that searches item text fields plus category/location keyword matches, merges and deduplicates results, and renders tappable rows that route directly to inventory detail.
- Files changed: `mobile/app/(tabs)/search/index.tsx`, `mobile/hooks/useInventorySearch.ts`, `mobile/hooks/index.ts`, `src/scripts/ralph/prd.json`, `src/scripts/ralph/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Use separate category/location ID lookups and feed those IDs into item queries, then merge with text matches to keep search robust without complex relational OR queries.
  - Gotchas encountered: Playwright MCP still could not reach local Vite from the MCP browser context in this environment (`ERR_CONNECTION_REFUSED`) even after starting dev server on `127.0.0.1:5173`.
  - Useful context: Browser verification commands executed: `mcporter list`, `mcporter call playwright.browser_navigate url=http://127.0.0.1:5173`, `mcporter call playwright.browser_snapshot`, `mcporter call playwright.browser_take_screenshot filename=us-017-verification.png` (artifact captured from the browser error page); iOS simulator verification remains manual.
---
## 2026-02-10 15:41 PST - US-018
- What was implemented: Replaced placeholder Marketplace feed/detail screens with Supabase-backed listing experiences. Added TanStack Query hooks to load active listings, hydrate listing item + seller profile context, and render robust loading/empty/error states. Listing rows now navigate into a real detail page showing item photo/name, price, condition, seller info, description, and listing metadata.
- Files changed: `mobile/hooks/useMarketplaceListings.ts`, `mobile/hooks/index.ts`, `mobile/app/(tabs)/marketplace/index.tsx`, `mobile/app/(tabs)/marketplace/[id].tsx`, `src/scripts/ralph/prd.json`, `src/scripts/ralph/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: None.
  - Gotchas encountered: Playwright MCP browser context still cannot reach local Vite server in this environment (`ERR_CONNECTION_REFUSED`) even when Vite is running on `127.0.0.1:5173`; browser verification remains limited to error-state artifact capture while iOS simulator verification is manual.
  - Useful context: Required verification commands executed: `mcporter list`, `mcporter call playwright.browser_navigate url=http://127.0.0.1:5173`, `mcporter call playwright.browser_snapshot`, `mcporter call playwright.browser_take_screenshot filename=us-018-verification-live.png`.
---
