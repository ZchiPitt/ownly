# Ralph Progress Log
Started: Tue Feb  3 02:02:53 PST 2026
---

## Codebase Patterns
- Edge Functions use `Deno.serve()` for HTTP handling and `corsHeaders` from `../_shared/cors.ts`
- Edge Functions use service role key for bypassing RLS when needed
- Use `jsr:@supabase/supabase-js@2` for Supabase client in Edge Functions
- Notifications table has `is_pushed` and `pushed_at` columns for tracking push delivery
- Push subscriptions store `endpoint`, `p256dh`, `auth` keys from Web Push API
- Database triggers use `pg_net` extension for async HTTP calls to Edge Functions
- Trigger configuration requires `app.settings.supabase_url` and `app.settings.service_role_key` via Supabase Vault
- User presence table tracks active_listing_id with last_seen timestamp for push suppression
- Hooks for database upserts should use type casting with `ReturnType<typeof supabase.from>` to handle typing issues
- Custom service worker code: use vite-plugin-pwa `workbox.importScripts` with files in `public/` directory

## 2026-02-03 - US-001
- **What was implemented**: Created `send-push-notification` Edge Function
- **Files changed**:
  - `supabase/functions/send-push-notification/index.ts` (new)
  - `CLAUDE.md` (updated Edge Functions table and VAPID documentation)
- **Learnings for future iterations:**
  - Web Push requires VAPID authentication with JWT tokens signed using ES256 (ECDSA P-256)
  - Deno's native `crypto.subtle` API can handle ECDH key agreement and AES-GCM encryption
  - Push subscriptions that return 404 or 410 should be removed (expired/unsubscribed)
  - VAPID_PUBLIC_KEY, VAPID_PRIVATE_KEY, and VAPID_SUBJECT must be set as Supabase secrets
  - The `aes128gcm` content encoding format requires specific header structure: salt (16 bytes) + record size (4 bytes) + keyid length (1 byte) + server public key (65 bytes) + encrypted data
---

## 2026-02-03 - US-002
- **What was implemented**: Created database trigger for notification push delivery
- **Files changed**:
  - `supabase/migrations/20260203000001_create_push_notification_trigger.sql` (new)
  - `supabase/functions/send-push-notification/index.ts` (updated)
- **Learnings for future iterations:**
  - `pg_net` extension enables async HTTP calls from database triggers without blocking
  - Trigger WHEN clause allows conditional execution (e.g., `WHEN (NEW.is_pushed = false)`)
  - Database settings for Edge Function URLs can be stored in Supabase Vault and accessed via `current_setting()`
  - AFTER INSERT triggers ensure the row exists when the Edge Function queries it
  - Edge Function should update `is_pushed = true` and `pushed_at = now()` after successful delivery to prevent duplicate pushes
---

## 2026-02-03 - US-003
- **What was implemented**: Added user presence tracking for smart push suppression
- **Files changed**:
  - `supabase/migrations/20260203000002_create_user_presence_table.sql` (new)
  - `supabase/migrations/20260203000003_add_presence_check_to_push_trigger.sql` (new)
  - `src/hooks/usePresence.ts` (new)
  - `src/pages/ChatPage.tsx` (updated - added presence tracking)
  - `src/types/database.ts` (updated - added UserPresence type)
- **Learnings for future iterations:**
  - Presence tracking uses a unique index on user_id to ensure one presence record per user
  - The usePresence hook uses setInterval (20s) to keep presence fresh while on a conversation
  - Trigger function extracts `listing_id` from notification `data` JSONB field for presence check
  - When skipping push due to presence, still mark `is_pushed = true` to prevent re-triggering
  - Type casting `supabase.from()` with `ReturnType<typeof supabase.from>` helps with upsert type issues
---

## 2026-02-03 - US-004
- **What was implemented**: Real-time chat push notifications with proper formatting and service worker click handling
- **Files changed**:
  - `src/lib/notifications.ts` (updated - new_message format and message_preview field)
  - `src/hooks/useMessages.ts` (updated - pass message preview to notification)
  - `public/sw-push.js` (new - custom service worker for push/click handling)
  - `vite.config.ts` (updated - importScripts for custom SW)
- **Learnings for future iterations:**
  - vite-plugin-pwa supports `importScripts` in workbox config to inject custom service worker code
  - Custom SW file goes in `public/` directory and is served at root (e.g., `/sw-push.js`)
  - Service worker `notificationclick` handler should use `clients.matchAll()` to find existing windows before opening new ones
  - Notification `data` object persists custom fields (type, listing_id) through to the click handler
  - Message preview should be truncated to 50 chars for push body to maintain readability
---
